<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>uk_dpdk（驱动部分） | TenonOS-unikraft-learning</title>
  <meta name="description" content="uk_dpdk&#x2F;libs 目录123456789101112131415├─librte_eal        &#x2F;&#x2F; EAL 层相关函数│  └─include├─librte_ethdev     &#x2F;&#x2F; 仅有 Makefile.uk├─librte_hash       &#x2F;&#x2F; 仅有 Makefile.uk├─librte_ip_frag    &#x2F;&#x2F; 仅有 Makefile.uk├─librte_">
<meta property="og:type" content="article">
<meta property="og:title" content="uk_dpdk（驱动部分）">
<meta property="og:url" content="http://example.com/2022/11/12/uk_dpdk%EF%BC%88%E9%A9%B1%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%89/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="uk_dpdk&#x2F;libs 目录123456789101112131415├─librte_eal        &#x2F;&#x2F; EAL 层相关函数│  └─include├─librte_ethdev     &#x2F;&#x2F; 仅有 Makefile.uk├─librte_hash       &#x2F;&#x2F; 仅有 Makefile.uk├─librte_ip_frag    &#x2F;&#x2F; 仅有 Makefile.uk├─librte_">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/unikraft_ukdpdk/mbuf2.svg">
<meta property="og:image" content="http://example.com/images/unikraft_ukdpdk/fbarray.png">
<meta property="og:image" content="http://example.com/images/unikraft_ukdpdk/init_dpdk.svg">
<meta property="article:published_time" content="2022-11-12T05:09:27.639Z">
<meta property="article:modified_time" content="2022-11-12T02:21:20.559Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="外部库">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/unikraft_ukdpdk/mbuf2.svg">
  <!-- Canonical links -->
  <link rel="canonical" href="http://example.com/2022/11/12/uk_dpdk%EF%BC%88%E9%A9%B1%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%89/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 5.4.2"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/TenonOS" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">TenonOS</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">unikraft-learning</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Zhejiang, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
            <span class="menu-title">书单</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/TenonOS" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/KVM%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96/">KVM与虚拟化</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%86%85%E5%AD%98/">内存</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E4%B8%8E%E5%AD%98%E5%82%A8/">文件系统与存储</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/">系统调用</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BA%BF%E7%A8%8B/">线程</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/">论文笔记</a><span class="category-list-count">10</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/HPC/" rel="tag">HPC</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/InfiniBand/" rel="tag">InfiniBand</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lib/" rel="tag">Lib</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Plat/" rel="tag">Plat</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RDMA/" rel="tag">RDMA</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Serverless/" rel="tag">Serverless</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unikernel/" rel="tag">Unikernel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hpc/" rel="tag">hpc</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/" rel="tag">函数调用</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" rel="tag">基础知识</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E5%BA%93/" rel="tag">外部库</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" rel="tag">系统调用</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/HPC/" style="font-size: 13.43px;">HPC</a> <a href="/tags/InfiniBand/" style="font-size: 13.57px;">InfiniBand</a> <a href="/tags/Lib/" style="font-size: 14px;">Lib</a> <a href="/tags/Plat/" style="font-size: 13.86px;">Plat</a> <a href="/tags/RDMA/" style="font-size: 13.57px;">RDMA</a> <a href="/tags/Serverless/" style="font-size: 13.29px;">Serverless</a> <a href="/tags/Unikernel/" style="font-size: 13px;">Unikernel</a> <a href="/tags/hpc/" style="font-size: 13.14px;">hpc</a> <a href="/tags/%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8/" style="font-size: 13px;">函数调用</a> <a href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" style="font-size: 13.71px;">基础知识</a> <a href="/tags/%E5%A4%96%E9%83%A8%E5%BA%93/" style="font-size: 13.57px;">外部库</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/" style="font-size: 13.14px;">系统调用</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">一月 2023</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">10</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">19</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/KVM%E4%B8%8E%E8%99%9A%E6%8B%9F%E5%8C%96/">KVM与虚拟化</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/25/%E5%8F%82%E6%95%B0%E4%BC%A0%E9%80%92/" class="title">用户与unikraft的参数传递</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-25T11:20:55.962Z" itemprop="datePublished">2023-01-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/">论文笔记</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/25/OSDI'22%20XRP/" class="title">OSDI&#39;22 XRP_In-Kernel Storage Functions with eBPF</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-25T11:20:55.850Z" itemprop="datePublished">2023-01-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E8%AE%BA%E6%96%87%E7%AC%94%E8%AE%B0/">论文笔记</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/25/OSDI'20%20A%20Simpler%20and%20Faster%20NIC%20Driver%20Model%20for%20Network%20Functions/" class="title">OSDI&#39;20 A Simpler and Faster NIC Driver Model for Network Functions</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-25T11:20:55.849Z" itemprop="datePublished">2023-01-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/25/InfiniBand%E8%B0%83%E7%A0%94/" class="title">InfiniBand调研</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-25T11:20:55.826Z" itemprop="datePublished">2023-01-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
              </p>
              <p class="item-title">
                <a href="/2023/01/25/InfiniBand-LinuxIB/" class="title">Linux InfiniBand</a>
              </p>
              <p class="item-date">
                <time datetime="2023-01-25T11:20:55.824Z" itemprop="datePublished">2023-01-25</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#uk-dpdk-libs-%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">uk_dpdk&#x2F;libs 目录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">数据结构简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rte-device"><span class="toc-number">2.1.</span> <span class="toc-text">rte_device</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rte-mbuf"><span class="toc-number">2.2.</span> <span class="toc-text">rte_mbuf</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rte-fbarray"><span class="toc-number">2.3.</span> <span class="toc-text">rte_fbarray</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#app-dumpcap-c-dpdk-init"><span class="toc-number">3.1.</span> <span class="toc-text">app&#x2F;dumpcap.c&#x2F;dpdk_init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uk-dpdk-libs-librte-eal-uk-eal-c-rte-eal-init"><span class="toc-number">3.2.</span> <span class="toc-text">uk-dpdk&#x2F;libs&#x2F;librte_eal&#x2F;uk_eal.c&#x2F;rte_eal_init</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eal-reset-internal-config"><span class="toc-number">3.2.1.</span> <span class="toc-text">eal_reset_internal_config</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-eal-cpu-init"><span class="toc-number">3.2.2.</span> <span class="toc-text">rte_eal_cpu_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eal-parse-args"><span class="toc-number">3.2.3.</span> <span class="toc-text">eal_parse_args</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eal-option-device-parse"><span class="toc-number">3.2.4.</span> <span class="toc-text">eal_option_device_parse</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-config-init"><span class="toc-number">3.2.5.</span> <span class="toc-text">rte_config_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eal-hugepage-info-init"><span class="toc-number">3.2.6.</span> <span class="toc-text">eal_hugepage_info_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-eal-memzone-init"><span class="toc-number">3.2.7.</span> <span class="toc-text">rte_eal_memzone_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-eal-memory-init"><span class="toc-number">3.2.8.</span> <span class="toc-text">rte_eal_memory_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-eal-malloc-heap-init"><span class="toc-number">3.2.9.</span> <span class="toc-text">rte_eal_malloc_heap_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rte-eal-tailqs-init"><span class="toc-number">3.2.10.</span> <span class="toc-text">rte_eal_tailqs_init</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eal-thread-init-master"><span class="toc-number">3.2.11.</span> <span class="toc-text">eal_thread_init_master</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-eal-uknetdev-init"><span class="toc-number">3.3.</span> <span class="toc-text">uk-dpdk&#x2F;libs&#x2F;libuk_pmd&#x2F;uk_pmd.c&#x2F;eal_uknetdev_init</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-create"><span class="toc-number">3.4.</span> <span class="toc-text">uk-dpdk&#x2F;libs&#x2F;libuk_pmd&#x2F;uk_pmd.c&#x2F;uk_ethdev_create</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dpdk-lib-ethdev-rte-ethdev-c-rte-eth-dev-probing-finish"><span class="toc-number">3.5.</span> <span class="toc-text">dpdk&#x2F;lib&#x2F;ethdev&#x2F;rte_ethdev.c&#x2F;rte_eth_dev_probing_finish</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE%E5%8C%85"><span class="toc-number">4.</span> <span class="toc-text">接收数据包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dpdk-lib-ethdev-rte-ethdev-h-rte-eth-rx-burst"><span class="toc-number">4.1.</span> <span class="toc-text">dpdk&#x2F;lib&#x2F;ethdev&#x2F;rte_ethdev.h&#x2F;rte_eth_rx_burst</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-rx-burst"><span class="toc-number">4.2.</span> <span class="toc-text">uk-dpdk&#x2F;libs&#x2F;libuk_pmd&#x2F;uk_pmd.c&#x2F;uk_ethdev_rx_burst</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-uk_dpdk（驱动部分）" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      uk_dpdk（驱动部分）
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2022/11/12/uk_dpdk%EF%BC%88%E9%A9%B1%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%89/" class="article-date">
	  <time datetime="2022-11-12T05:09:27.639Z" itemprop="datePublished">2022-11-12</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/%E5%A4%96%E9%83%A8%E5%BA%93/" rel="tag">外部库</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2022/11/12/uk_dpdk%EF%BC%88%E9%A9%B1%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%89/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h1 id="uk-dpdk-libs-目录"><a href="#uk-dpdk-libs-目录" class="headerlink" title="uk_dpdk/libs 目录"></a>uk_dpdk/libs 目录</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">├─librte_eal        <span class="comment">// EAL 层相关函数</span></span><br><span class="line">│  └─include</span><br><span class="line">├─librte_ethdev     <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_hash       <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_ip_frag    <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_kvargs     <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_mbuf       <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_mempool    <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_meter      <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_net        <span class="comment">// 仅有 Makefile.uk</span></span><br><span class="line">├─librte_ring       <span class="comment">// ring 相关操作函数</span></span><br><span class="line">├─librte_uknetbuf   <span class="comment">// netbuf 相关操作函数</span></span><br><span class="line">└─libuk_pmd</span><br><span class="line">    └─include</span><br><span class="line">        └─uk</span><br></pre></td></tr></table></figure>

<h1 id="数据结构简介"><a href="#数据结构简介" class="headerlink" title="数据结构简介"></a>数据结构简介</h1><h2 id="rte-device"><a href="#rte-device" class="headerlink" title="rte_device"></a>rte_device</h2><p>该结构体用于抽象的描述一个运行时通用设备，位于 DPDK 侧。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_device</span> &#123;</span></span><br><span class="line">	<span class="comment">// 链表中下一个设备</span></span><br><span class="line">	RTE_TAILQ_ENTRY(rte_device) next; <span class="comment">/**&lt; Next device */</span></span><br><span class="line">	<span class="comment">// 设备名称</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;             <span class="comment">/**&lt; Device name */</span></span><br><span class="line">	<span class="comment">// 设备驱动</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rte_driver</span> *<span class="title">driver</span>;</span> <span class="comment">/**&lt; Driver assigned after probing */</span></span><br><span class="line">	<span class="comment">// 总线相关操作函数</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">rte_bus</span> *<span class="title">bus</span>;</span>    <span class="comment">/**&lt; Bus handle assigned on scan */</span></span><br><span class="line">	<span class="comment">// 非统一内存访问节点连接</span></span><br><span class="line">	<span class="type">int</span> numa_node;                <span class="comment">/**&lt; NUMA node connection */</span></span><br><span class="line">	<span class="comment">// 最后一次探测到的设备参数</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_devargs</span> *<span class="title">devargs</span>;</span>  <span class="comment">/**&lt; Arguments for latest probing */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="rte-mbuf"><a href="#rte-mbuf" class="headerlink" title="rte_mbuf"></a>rte_mbuf</h2><p>mbuf 类似于 netbuf，是 DPDK 侧用于存储数据的结构</p>
<p><img src="/images/unikraft_ukdpdk/mbuf2.svg" alt="mbuf"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf</span> &#123;</span></span><br><span class="line">	RTE_MARKER cacheline0;</span><br><span class="line"></span><br><span class="line">	<span class="type">void</span> *buf_addr;           <span class="comment">/**&lt; Virtual address of segment buffer. */</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Physical address of segment buffer.</span></span><br><span class="line"><span class="comment">	 * Force alignment to 8-bytes, so as to ensure we have the exact</span></span><br><span class="line"><span class="comment">	 * same mbuf cacheline0 layout for 32-bit and 64-bit. This makes</span></span><br><span class="line"><span class="comment">	 * working on vector drivers easier.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">rte_iova_t</span> buf_iova __rte_aligned(<span class="keyword">sizeof</span>(<span class="type">rte_iova_t</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* next 8 bytes are initialised on RX descriptor rearm */</span></span><br><span class="line">	RTE_MARKER64 rearm_data;</span><br><span class="line">	<span class="type">uint16_t</span> data_off;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Reference counter. Its size should at least equal to the size</span></span><br><span class="line"><span class="comment">	 * of port field (16 bits), to support zero-copy broadcast.</span></span><br><span class="line"><span class="comment">	 * It should only be accessed using the following functions:</span></span><br><span class="line"><span class="comment">	 * rte_mbuf_refcnt_update(), rte_mbuf_refcnt_read(), and</span></span><br><span class="line"><span class="comment">	 * rte_mbuf_refcnt_set(). The functionality of these functions (atomic,</span></span><br><span class="line"><span class="comment">	 * or non-atomic) is controlled by the RTE_MBUF_REFCNT_ATOMIC flag.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">uint16_t</span> refcnt;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Number of segments. Only valid for the first segment of an mbuf</span></span><br><span class="line"><span class="comment">	 * chain.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">uint16_t</span> nb_segs;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Input port (16 bits to support more than 256 virtual ports).</span></span><br><span class="line"><span class="comment">	 * The event eth Tx adapter uses this field to specify the output port.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">uint16_t</span> port;</span><br><span class="line"></span><br><span class="line">	<span class="type">uint64_t</span> ol_flags;        <span class="comment">/**&lt; Offload features. */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* remaining bytes are set on RX when pulling packet from descriptor */</span></span><br><span class="line">	RTE_MARKER rx_descriptor_fields1;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The packet type, which is the combination of outer/inner L2, L3, L4</span></span><br><span class="line"><span class="comment">	 * and tunnel types. The packet_type is about data really present in the</span></span><br><span class="line"><span class="comment">	 * mbuf. Example: if vlan stripping is enabled, a received vlan packet</span></span><br><span class="line"><span class="comment">	 * would have RTE_PTYPE_L2_ETHER and not RTE_PTYPE_L2_VLAN because the</span></span><br><span class="line"><span class="comment">	 * vlan is stripped from the data.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	RTE_STD_C11</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> packet_type; <span class="comment">/**&lt; L2/L3/L4 and tunnel information. */</span></span><br><span class="line">		__extension__</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">uint8_t</span> l2_type:<span class="number">4</span>;   <span class="comment">/**&lt; (Outer) L2 type. */</span></span><br><span class="line">			<span class="type">uint8_t</span> l3_type:<span class="number">4</span>;   <span class="comment">/**&lt; (Outer) L3 type. */</span></span><br><span class="line">			<span class="type">uint8_t</span> l4_type:<span class="number">4</span>;   <span class="comment">/**&lt; (Outer) L4 type. */</span></span><br><span class="line">			<span class="type">uint8_t</span> tun_type:<span class="number">4</span>;  <span class="comment">/**&lt; Tunnel type. */</span></span><br><span class="line">			RTE_STD_C11</span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="type">uint8_t</span> inner_esp_next_proto;</span><br><span class="line">				<span class="comment">/**&lt; ESP next protocol type, valid if</span></span><br><span class="line"><span class="comment">				 * RTE_PTYPE_TUNNEL_ESP tunnel type is set</span></span><br><span class="line"><span class="comment">				 * on both Tx and Rx.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				__extension__</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">					<span class="type">uint8_t</span> inner_l2_type:<span class="number">4</span>;</span><br><span class="line">					<span class="comment">/**&lt; Inner L2 type. */</span></span><br><span class="line">					<span class="type">uint8_t</span> inner_l3_type:<span class="number">4</span>;</span><br><span class="line">					<span class="comment">/**&lt; Inner L3 type. */</span></span><br><span class="line">				&#125;;</span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="type">uint8_t</span> inner_l4_type:<span class="number">4</span>; <span class="comment">/**&lt; Inner L4 type. */</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">uint32_t</span> pkt_len;         <span class="comment">/**&lt; Total pkt len: sum of all segments. */</span></span><br><span class="line">	<span class="type">uint16_t</span> data_len;        <span class="comment">/**&lt; Amount of data in segment buffer. */</span></span><br><span class="line">	<span class="comment">/** VLAN TCI (CPU order), valid if RTE_MBUF_F_RX_VLAN is set. */</span></span><br><span class="line">	<span class="type">uint16_t</span> vlan_tci;</span><br><span class="line"></span><br><span class="line">	RTE_STD_C11</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">			<span class="type">uint32_t</span> rss;     <span class="comment">/**&lt; RSS hash result if RSS enabled */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">					<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">						<span class="type">uint16_t</span> hash;</span><br><span class="line">						<span class="type">uint16_t</span> id;</span><br><span class="line">					&#125;;</span><br><span class="line">					<span class="type">uint32_t</span> lo;</span><br><span class="line">					<span class="comment">/**&lt; Second 4 flexible bytes */</span></span><br><span class="line">				&#125;;</span><br><span class="line">				<span class="type">uint32_t</span> hi;</span><br><span class="line">				<span class="comment">/**&lt; First 4 flexible bytes or FD ID, dependent</span></span><br><span class="line"><span class="comment">				 * on RTE_MBUF_F_RX_FDIR_* flag in ol_flags.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">			&#125; fdir;	<span class="comment">/**&lt; Filter identifier if FDIR enabled */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf_sched</span> <span class="title">sched</span>;</span></span><br><span class="line">			<span class="comment">/**&lt; Hierarchical scheduler : 8 bytes */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">				<span class="type">uint32_t</span> reserved1;</span><br><span class="line">				<span class="type">uint16_t</span> reserved2;</span><br><span class="line">				<span class="type">uint16_t</span> txq;</span><br><span class="line">				<span class="comment">/**&lt; The event eth Tx adapter uses this field</span></span><br><span class="line"><span class="comment">				 * to store Tx queue id.</span></span><br><span class="line"><span class="comment">				 * @see rte_event_eth_tx_adapter_txq_set()</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">			&#125; txadapter; <span class="comment">/**&lt; Eventdev ethdev Tx adapter */</span></span><br><span class="line">			<span class="comment">/**&lt; User defined tags. See rte_distributor_process() */</span></span><br><span class="line">			<span class="type">uint32_t</span> usr;</span><br><span class="line">		&#125; hash;                   <span class="comment">/**&lt; hash information */</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Outer VLAN TCI (CPU order), valid if RTE_MBUF_F_RX_QINQ is set. */</span></span><br><span class="line">	<span class="type">uint16_t</span> vlan_tci_outer;</span><br><span class="line"></span><br><span class="line">	<span class="type">uint16_t</span> buf_len;         <span class="comment">/**&lt; Length of segment buffer. */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mempool</span> *<span class="title">pool</span>;</span> <span class="comment">/**&lt; Pool from which mbuf was allocated. */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* second cache line - fields only used in slow path or on TX */</span></span><br><span class="line">	RTE_MARKER cacheline1 __rte_cache_min_aligned;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Next segment of scattered packet. Must be NULL in the last segment or</span></span><br><span class="line"><span class="comment">	 * in case of non-segmented packet.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf</span> *<span class="title">next</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fields to support TX offloads */</span></span><br><span class="line">	RTE_STD_C11</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint64_t</span> tx_offload;       <span class="comment">/**&lt; combined for easy fetch */</span></span><br><span class="line">		__extension__</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">uint64_t</span> l2_len:RTE_MBUF_L2_LEN_BITS;</span><br><span class="line">			<span class="comment">/**&lt; L2 (MAC) Header Length for non-tunneling pkt.</span></span><br><span class="line"><span class="comment">			 * Outer_L4_len + ... + Inner_L2_len for tunneling pkt.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="type">uint64_t</span> l3_len:RTE_MBUF_L3_LEN_BITS;</span><br><span class="line">			<span class="comment">/**&lt; L3 (IP) Header Length. */</span></span><br><span class="line">			<span class="type">uint64_t</span> l4_len:RTE_MBUF_L4_LEN_BITS;</span><br><span class="line">			<span class="comment">/**&lt; L4 (TCP/UDP) Header Length. */</span></span><br><span class="line">			<span class="type">uint64_t</span> tso_segsz:RTE_MBUF_TSO_SEGSZ_BITS;</span><br><span class="line">			<span class="comment">/**&lt; TCP TSO segment size */</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Fields for Tx offloading of tunnels.</span></span><br><span class="line"><span class="comment">			 * These are undefined for packets which don&#x27;t request</span></span><br><span class="line"><span class="comment">			 * any tunnel offloads (outer IP or UDP checksum,</span></span><br><span class="line"><span class="comment">			 * tunnel TSO).</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * PMDs should not use these fields unconditionally</span></span><br><span class="line"><span class="comment">			 * when calculating offsets.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * Applications are expected to set appropriate tunnel</span></span><br><span class="line"><span class="comment">			 * offload flags when they fill in these fields.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="type">uint64_t</span> outer_l3_len:RTE_MBUF_OUTL3_LEN_BITS;</span><br><span class="line">			<span class="comment">/**&lt; Outer L3 (IP) Hdr Length. */</span></span><br><span class="line">			<span class="type">uint64_t</span> outer_l2_len:RTE_MBUF_OUTL2_LEN_BITS;</span><br><span class="line">			<span class="comment">/**&lt; Outer L2 (MAC) Hdr Length. */</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">/* uint64_t unused:RTE_MBUF_TXOFLD_UNUSED_BITS; */</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Shared data for external buffer attached to mbuf. See</span></span><br><span class="line"><span class="comment">	 * rte_pktmbuf_attach_extbuf().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf_ext_shared_info</span> *<span class="title">shinfo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Size of the application private data. In case of an indirect</span></span><br><span class="line"><span class="comment">	 * mbuf, it stores the direct mbuf private data size.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">uint16_t</span> priv_size;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/** Timesync flags for use with IEEE1588. */</span></span><br><span class="line">	<span class="type">uint16_t</span> timesync;</span><br><span class="line"></span><br><span class="line">	<span class="type">uint32_t</span> dynfield1[<span class="number">9</span>]; <span class="comment">/**&lt; Reserved for dynamic fields. */</span></span><br><span class="line">&#125; __rte_cache_aligned;</span><br></pre></td></tr></table></figure>

<h2 id="rte-fbarray"><a href="#rte-fbarray" class="headerlink" title="rte_fbarray"></a>rte_fbarray</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_fbarray</span> &#123;</span></span><br><span class="line">	<span class="type">char</span> name[RTE_FBARRAY_NAME_LEN]; <span class="comment">/**&lt; name associated with an array */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> count;              <span class="comment">/**&lt; number of entries stored */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> len;                <span class="comment">/**&lt; current length of the array */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> elt_sz;             <span class="comment">/**&lt; size of each element */</span></span><br><span class="line">	<span class="type">void</span> *data;                      <span class="comment">/**&lt; data pointer */</span></span><br><span class="line">	<span class="type">rte_rwlock_t</span> rwlock;             <span class="comment">/**&lt; multiprocess lock */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/images/unikraft_ukdpdk/fbarray.png" alt="fbarray"></p>
<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><h2 id="app-dumpcap-c-dpdk-init"><a href="#app-dumpcap-c-dpdk-init" class="headerlink" title="app/dumpcap.c/dpdk_init"></a><code>app/dumpcap.c/dpdk_init</code></h2><p>以 <code>app/dumpcap</code> 为例，在应用程序的 main 函数中，调取 <code>dpdk_init</code> 对 DPDK 进行初始化。由于 <code>rte_eal_init</code> 函数是以 argc/argv 的形式调用的，故需要对这两个参数进行初始化并完成传入。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dpdk_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 需要传入的参数</span></span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> args[] = &#123;</span><br><span class="line">		<span class="string">&quot;dumpcap&quot;</span>, <span class="string">&quot;--proc-type&quot;</span>, <span class="string">&quot;secondary&quot;</span>,</span><br><span class="line">		<span class="string">&quot;--log-level&quot;</span>, <span class="string">&quot;notice&quot;</span></span><br><span class="line"></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">// RTE_DIM 为计算元素个数的宏定义</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> eal_argc = RTE_DIM(args);</span><br><span class="line">	<span class="type">char</span> **eal_argv;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* DPDK API requires mutable versions of command line arguments. */</span></span><br><span class="line">	<span class="comment">// 为参数数组分配内存</span></span><br><span class="line">	eal_argv = <span class="built_in">calloc</span>(eal_argc + <span class="number">1</span>, <span class="keyword">sizeof</span>(<span class="type">char</span> *));</span><br><span class="line">	<span class="keyword">if</span> (eal_argv == <span class="literal">NULL</span>)</span><br><span class="line">		rte_panic(<span class="string">&quot;No memory\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 复制参数</span></span><br><span class="line">	eal_argv[<span class="number">0</span>] = strdup(progname);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; RTE_DIM(args); i++)</span><br><span class="line">		eal_argv[i] = strdup(args[i]);</span><br><span class="line">	<span class="comment">// 传入参数进行初始化</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_init(eal_argc, eal_argv) &lt; <span class="number">0</span>)</span><br><span class="line">		rte_exit(EXIT_FAILURE, <span class="string">&quot;EAL init failed: is primary process running?\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 获取可用端口数量</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eth_dev_count_avail() == <span class="number">0</span>)</span><br><span class="line">		rte_exit(EXIT_FAILURE, <span class="string">&quot;No Ethernet ports found\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="uk-dpdk-libs-librte-eal-uk-eal-c-rte-eal-init"><a href="#uk-dpdk-libs-librte-eal-uk-eal-c-rte-eal-init" class="headerlink" title="uk-dpdk/libs/librte_eal/uk_eal.c/rte_eal_init"></a><code>uk-dpdk/libs/librte_eal/uk_eal.c/rte_eal_init</code></h2><p><img src="/images/unikraft_ukdpdk/init_dpdk.svg" alt="init_dpdk"></p>
<p>在这里将传入的字符串参数转化为 <code>internal_config</code> 结构体的内部参数后完成 EAL 层的各参数配置，最后调用 <code>eal_uknetdev_init</code> 函数将所有的 <code>uk_netdev</code> 注册成 <code>eth_dev</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rte_eal_init</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line">	<span class="comment">// 重置设备内部配置</span></span><br><span class="line">	eal_reset_internal_config(&amp;internal_config);</span><br><span class="line">	<span class="comment">// 获取 CPU 信息并填充 cpu_info 结构体</span></span><br><span class="line">	<span class="comment">// location: dpdk\lib\eal\common\eal_common_lcore.c</span></span><br><span class="line">	rc = rte_eal_cpu_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to initialize the CPU\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uk_pr_debug(<span class="string">&quot;initialized the cpu_init\n&quot;</span>);</span><br><span class="line">	internal_config.no_shconf = <span class="number">1</span>;</span><br><span class="line">	internal_config.memory = MEMSIZE_IF_NO_HUGE_PAGE;</span><br><span class="line">	internal_config.legacy_mem = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Parse the argument.</span></span><br><span class="line"><span class="comment">	 * 将传入的字符串参数转化为 internal_config 结构体内部参数</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rc = eal_parse_args(argc, argv);</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to parse the argument to library\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	uk_pr_debug(<span class="string">&quot;parsed argument\n&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Process the arguments on the device</span></span><br><span class="line"><span class="comment">	 * 在 Unikraft 中，该函数无实际效果</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rc = eal_option_device_parse();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to parse the device\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">	uk_pr_debug(<span class="string">&quot;dev_args parsed\n&quot;</span>);</span><br><span class="line">	<span class="comment">// 如果是主进程则初始化配置</span></span><br><span class="line">	rte_config_init();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure the heap based on the huge page information.</span></span><br><span class="line"><span class="comment">	 * 配置大内存页 </span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rc = eal_hugepage_info_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to fetch hugetable info\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Memzone initialization configure the fbarray.</span></span><br><span class="line"><span class="comment">	 * 初始化内存区子系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rc = rte_eal_memzone_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to initialize the memory zone\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">TODO:</span></span></span><br><span class="line"><span class="comment">	 * Check if we need changes to configure</span></span><br><span class="line"><span class="comment">	 * - memseg</span></span><br><span class="line"><span class="comment">	 * - memalloc</span></span><br><span class="line"><span class="comment">	 * 初始化内存子系统</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rc = rte_eal_memory_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to initialize the memory\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 初始化堆</span></span><br><span class="line">	rc = rte_eal_malloc_heap_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to initialize heap\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 初始化队列</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_tailqs_init() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Cannot init tail queues for objects\n&quot;</span>);</span><br><span class="line">		rte_errno = EFAULT;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 初始化线程并设置 affinity</span></span><br><span class="line">	eal_thread_init_master(rte_config.master_lcore);</span><br><span class="line"></span><br><span class="line">	rc = eal_uknetdev_init();</span><br><span class="line">	<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed(%d) to initializes the netdevice\n&quot;</span>, rc);</span><br><span class="line">		<span class="keyword">return</span> rc;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eal-reset-internal-config"><a href="#eal-reset-internal-config" class="headerlink" title="eal_reset_internal_config"></a>eal_reset_internal_config</h3><p>TODO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">eal_reset_internal_config</span><span class="params">(<span class="keyword">struct</span> internal_config *internal_cfg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">	internal_cfg-&gt;memory = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;force_nrank = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;force_nchannel = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;hugefile_prefix = <span class="literal">NULL</span>;</span><br><span class="line">	internal_cfg-&gt;hugepage_dir = <span class="literal">NULL</span>;</span><br><span class="line">	internal_cfg-&gt;force_sockets = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* zero out the NUMA config */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; RTE_MAX_NUMA_NODES; i++)</span><br><span class="line">		internal_cfg-&gt;socket_mem[i] = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;force_socket_limits = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* zero out the NUMA limits config */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; RTE_MAX_NUMA_NODES; i++)</span><br><span class="line">		internal_cfg-&gt;socket_limit[i] = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* zero out hugedir descriptors */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_HUGEPAGE_SIZES; i++) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(&amp;internal_cfg-&gt;hugepage_info[i], <span class="number">0</span>,</span><br><span class="line">				<span class="keyword">sizeof</span>(internal_cfg-&gt;hugepage_info[<span class="number">0</span>]));</span><br><span class="line">		internal_cfg-&gt;hugepage_info[i].lock_descriptor = <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	internal_cfg-&gt;base_virtaddr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LOG_DAEMON</span></span><br><span class="line">	internal_cfg-&gt;syslog_facility = LOG_DAEMON;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* if set to NONE, interrupt mode is determined automatically */</span></span><br><span class="line">	internal_cfg-&gt;vfio_intr_mode = RTE_INTR_MODE_NONE;</span><br><span class="line">	<span class="built_in">memset</span>(internal_cfg-&gt;vfio_vf_token, <span class="number">0</span>,</span><br><span class="line">			<span class="keyword">sizeof</span>(internal_cfg-&gt;vfio_vf_token));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTE_LIBEAL_USE_HPET</span></span><br><span class="line">	internal_cfg-&gt;no_hpet = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	internal_cfg-&gt;no_hpet = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	internal_cfg-&gt;vmware_tsc_map = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;create_uio_dev = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;iova_mode = RTE_IOVA_DC;</span><br><span class="line">	internal_cfg-&gt;user_mbuf_pool_ops_name = <span class="literal">NULL</span>;</span><br><span class="line">	CPU_ZERO(&amp;internal_cfg-&gt;ctrl_cpuset);</span><br><span class="line">	internal_cfg-&gt;init_complete = <span class="number">0</span>;</span><br><span class="line">	internal_cfg-&gt;max_simd_bitwidth.bitwidth = RTE_VECT_DEFAULT_SIMD_BITWIDTH;</span><br><span class="line">	internal_cfg-&gt;max_simd_bitwidth.forced = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-eal-cpu-init"><a href="#rte-eal-cpu-init" class="headerlink" title="rte_eal_cpu_init"></a>rte_eal_cpu_init</h3><p>TODO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">rte_eal_cpu_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* pointer to global configuration */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_config</span> *<span class="title">config</span> =</span> rte_eal_get_configuration();</span><br><span class="line">	<span class="type">unsigned</span> lcore_id;</span><br><span class="line">	<span class="type">unsigned</span> count = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> socket_id, prev_socket_id;</span><br><span class="line">	<span class="type">int</span> lcore_to_socket_id[RTE_MAX_LCORE];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Parse the maximum set of logical cores, detect the subset of running</span></span><br><span class="line"><span class="comment">	 * ones and enable them by default.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">for</span> (lcore_id = <span class="number">0</span>; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) &#123;</span><br><span class="line">		lcore_config[lcore_id].core_index = count;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* init cpuset for per lcore config */</span></span><br><span class="line">		CPU_ZERO(&amp;lcore_config[lcore_id].cpuset);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* find socket first */</span></span><br><span class="line">		socket_id = eal_cpu_socket_id(lcore_id);</span><br><span class="line">		lcore_to_socket_id[lcore_id] = socket_id;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (eal_cpu_detected(lcore_id) == <span class="number">0</span>) &#123;</span><br><span class="line">			config-&gt;lcore_role[lcore_id] = ROLE_OFF;</span><br><span class="line">			lcore_config[lcore_id].core_index = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* By default, lcore 1:1 map to cpu id */</span></span><br><span class="line">		CPU_SET(lcore_id, &amp;lcore_config[lcore_id].cpuset);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* By default, each detected core is enabled */</span></span><br><span class="line">		config-&gt;lcore_role[lcore_id] = ROLE_RTE;</span><br><span class="line">		lcore_config[lcore_id].core_role = ROLE_RTE;</span><br><span class="line">		lcore_config[lcore_id].core_id = eal_cpu_core_id(lcore_id);</span><br><span class="line">		lcore_config[lcore_id].socket_id = socket_id;</span><br><span class="line">		RTE_LOG(DEBUG, EAL, <span class="string">&quot;Detected lcore %u as &quot;</span></span><br><span class="line">				<span class="string">&quot;core %u on socket %u\n&quot;</span>,</span><br><span class="line">				lcore_id, lcore_config[lcore_id].core_id,</span><br><span class="line">				lcore_config[lcore_id].socket_id);</span><br><span class="line">		count++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (; lcore_id &lt; CPU_SETSIZE; lcore_id++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (eal_cpu_detected(lcore_id) == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		RTE_LOG(DEBUG, EAL, <span class="string">&quot;Skipped lcore %u as core %u on socket %u\n&quot;</span>,</span><br><span class="line">			lcore_id, eal_cpu_core_id(lcore_id),</span><br><span class="line">			eal_cpu_socket_id(lcore_id));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set the count of enabled logical cores of the EAL configuration */</span></span><br><span class="line">	config-&gt;lcore_count = count;</span><br><span class="line">	RTE_LOG(DEBUG, EAL,</span><br><span class="line">			<span class="string">&quot;Maximum logical cores by configuration: %u\n&quot;</span>,</span><br><span class="line">			RTE_MAX_LCORE);</span><br><span class="line">	RTE_LOG(INFO, EAL, <span class="string">&quot;Detected CPU lcores: %u\n&quot;</span>, config-&gt;lcore_count);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sort all socket id&#x27;s in ascending order */</span></span><br><span class="line">	qsort(lcore_to_socket_id, RTE_DIM(lcore_to_socket_id),</span><br><span class="line">			<span class="keyword">sizeof</span>(lcore_to_socket_id[<span class="number">0</span>]), socket_id_cmp);</span><br><span class="line"></span><br><span class="line">	prev_socket_id = <span class="number">-1</span>;</span><br><span class="line">	config-&gt;numa_node_count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (lcore_id = <span class="number">0</span>; lcore_id &lt; RTE_MAX_LCORE; lcore_id++) &#123;</span><br><span class="line">		socket_id = lcore_to_socket_id[lcore_id];</span><br><span class="line">		<span class="keyword">if</span> (socket_id != prev_socket_id)</span><br><span class="line">			config-&gt;numa_nodes[config-&gt;numa_node_count++] =</span><br><span class="line">					socket_id;</span><br><span class="line">		prev_socket_id = socket_id;</span><br><span class="line">	&#125;</span><br><span class="line">	RTE_LOG(INFO, EAL, <span class="string">&quot;Detected NUMA nodes: %u\n&quot;</span>, config-&gt;numa_node_count);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eal-parse-args"><a href="#eal-parse-args" class="headerlink" title="eal_parse_args"></a>eal_parse_args</h3><p>TODO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">eal_parse_args</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line">	<span class="type">char</span> **argvopt;</span><br><span class="line">	<span class="type">int</span> option_index = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> *prgname = argv[<span class="number">0</span>];</span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> old_optind = optind;</span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> old_optopt = optopt;</span><br><span class="line">	<span class="type">char</span> * <span class="type">const</span> old_optarg = optarg;</span><br><span class="line">	<span class="type">int</span> opt;</span><br><span class="line"></span><br><span class="line">	argvopt = argv;</span><br><span class="line">	optind = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined(CONFIG_HUGEPAGE_DIR) &amp;&amp; !defined(CONFIG_HUGEPAGE_FILE)</span></span><br><span class="line">	internal_config.no_hugetlbfs = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* !CONFIG_HUGEPAGE_DIR &amp;&amp; !CONFIG_HUGEPAGE_FILE */</span></span></span><br><span class="line">	<span class="keyword">while</span> ((opt = getopt_long(argc, argvopt, eal_short_options,</span><br><span class="line">				  eal_long_options, &amp;option_index)) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="comment">/* getopt is not happy, stop right now */</span></span><br><span class="line">		<span class="keyword">if</span> (opt == <span class="string">&#x27;?&#x27;</span>) &#123;</span><br><span class="line">			uk_pr_err(<span class="string">&quot;Get opt long is not happy\n&quot;</span>);</span><br><span class="line">			eal_usage(prgname);</span><br><span class="line">			rc = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Opt: %d and optarg: %s\n&quot;</span>, opt, optarg);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">			eal_usage(prgname);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">		<span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">			RTE_LOG(ERR, EAL, <span class="string">&quot;Unikraft does not support loading modules\n&quot;</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> OPT_PROC_TYPE_NUM:</span><br><span class="line">			internal_config.process_type = RTE_PROC_PRIMARY;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HUGEPAGE_DIR</span></span><br><span class="line">		<span class="keyword">case</span> OPT_HUGE_DIR_NUM:</span><br><span class="line">			internal_config.hugepage_dir = strdup(optarg);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_HUGEPAGE_DIR */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HUGEPAGE_FILE</span></span><br><span class="line">		<span class="keyword">case</span> OPT_FILE_PREFIX_NUM:</span><br><span class="line">			internal_config.hugefile_prefix = strdup(optarg);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_HUGEPAGE_FILE */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SOCKET_MEM_NUM</span></span><br><span class="line">		<span class="keyword">case</span> OPT_SOCKET_MEM_NUM:</span><br><span class="line">			<span class="keyword">if</span> (eal_parse_socket_mem(optarg) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				RTE_LOG(ERR, EAL, <span class="string">&quot;invalid parameters for --&quot;</span></span><br><span class="line">						OPT_SOCKET_MEM <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">				eal_usage(prgname);</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SOCKET_MEM_NUM */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VIRTADDR_NUM</span></span><br><span class="line">		<span class="keyword">case</span> OPT_BASE_VIRTADDR_NUM:</span><br><span class="line">			<span class="keyword">if</span> (eal_parse_base_virtaddr(optarg) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				RTE_LOG(ERR, EAL, <span class="string">&quot;invalid parameter for --&quot;</span></span><br><span class="line">						OPT_BASE_VIRTADDR <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">				eal_usage(prgname);</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_VIRTADDR_NUM */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_VFIO_INTR_NUM</span></span><br><span class="line">		<span class="keyword">case</span> OPT_VFIO_INTR_NUM:</span><br><span class="line">			<span class="keyword">if</span> (eal_parse_vfio_intr(optarg) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				RTE_LOG(ERR, EAL, <span class="string">&quot;invalid parameters for --&quot;</span></span><br><span class="line">						OPT_VFIO_INTR <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">				eal_usage(prgname);</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_VFIO_INTR_NUM */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_UIO_DEV</span></span><br><span class="line">		<span class="keyword">case</span> OPT_CREATE_UIO_DEV_NUM:</span><br><span class="line">			internal_config.create_uio_dev = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_UIO_DEV_NUM */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MBUF_POOL_OPS_NAME</span></span><br><span class="line">		<span class="keyword">case</span> OPT_MBUF_POOL_OPS_NAME_NUM:</span><br><span class="line">			internal_config.mbuf_pool_ops_name = optarg;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_MBUF_POOL_OPS_NAME */</span></span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * Parse common options later to enable overriding</span></span><br><span class="line"><span class="comment">			 * default common options</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			rc = eal_parse_common_option(opt, optarg,</span><br><span class="line">						     &amp;internal_config);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* common parser handled this option */</span></span><br><span class="line">			<span class="keyword">if</span> (rc == <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="comment">/* common parser is not happy */</span></span><br><span class="line">			<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">				eal_usage(prgname);</span><br><span class="line">				rc = <span class="number">-1</span>;</span><br><span class="line">				<span class="keyword">goto</span> out;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (opt &lt; OPT_LONG_MIN_NUM &amp;&amp; <span class="built_in">isprint</span>(opt))</span><br><span class="line">				uk_pr_err(<span class="string">&quot;Option %c is not supported on Unikraft\n&quot;</span>,</span><br><span class="line">					opt);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (opt &gt;= OPT_LONG_MIN_NUM &amp;&amp;</span><br><span class="line">				 opt &lt; OPT_LONG_MAX_NUM)</span><br><span class="line">				 uk_pr_err(<span class="string">&quot;Option %s is not supported on Unikraft\n&quot;</span>,</span><br><span class="line">					eal_long_options[option_index].name);</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				uk_pr_err( <span class="string">&quot;Option %d is not supported on Unikraft\n&quot;</span>,</span><br><span class="line">					opt);</span><br><span class="line"></span><br><span class="line">			eal_usage(prgname);</span><br><span class="line">			rc = <span class="number">-1</span>;</span><br><span class="line">			<span class="keyword">goto</span> out;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (eal_adjust_config(&amp;internal_config) != <span class="number">0</span>) &#123;</span><br><span class="line">		rc = <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* sanity checks */</span></span><br><span class="line">	<span class="keyword">if</span> (eal_check_common_options(&amp;internal_config) != <span class="number">0</span>) &#123;</span><br><span class="line">	        eal_usage(prgname);</span><br><span class="line">	        rc = <span class="number">-1</span>;</span><br><span class="line">	        <span class="keyword">goto</span> out;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (optind &gt;= <span class="number">0</span>)</span><br><span class="line">		argv[optind<span class="number">-1</span>] = prgname;</span><br><span class="line">	rc = optind<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="comment">/* restore getopt lib */</span></span><br><span class="line">	optind = old_optind;</span><br><span class="line">	optopt = old_optopt;</span><br><span class="line">	optarg = old_optarg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eal-option-device-parse"><a href="#eal-option-device-parse" class="headerlink" title="eal_option_device_parse"></a>eal_option_device_parse</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">eal_option_device_parse</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_option</span> *<span class="title">devopt</span>;</span></span><br><span class="line">	<span class="type">void</span> *tmp;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	RTE_TAILQ_FOREACH_SAFE(devopt, &amp;devopt_list, next, tmp) &#123;</span><br><span class="line">		<span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">// unikraft 下的该函数直接返回 0</span></span><br><span class="line">			ret = rte_devargs_add(devopt-&gt;type, devopt-&gt;arg);</span><br><span class="line">			<span class="keyword">if</span> (ret)</span><br><span class="line">				RTE_LOG(ERR, EAL, <span class="string">&quot;Unable to parse device &#x27;%s&#x27;\n&quot;</span>,</span><br><span class="line">					devopt-&gt;arg);</span><br><span class="line">		&#125;</span><br><span class="line">		TAILQ_REMOVE(&amp;devopt_list, devopt, next);</span><br><span class="line">		<span class="built_in">free</span>(devopt);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-config-init"><a href="#rte-config-init" class="headerlink" title="rte_config_init"></a>rte_config_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">rte_config_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	rte_config.process_type = internal_config.process_type;</span><br><span class="line">	<span class="keyword">switch</span> (rte_config.process_type)&#123;</span><br><span class="line">	<span class="keyword">case</span> RTE_PROC_PRIMARY:</span><br><span class="line">		uk_pr_debug(<span class="string">&quot;Initializing the primary process config\n&quot;</span>);</span><br><span class="line">		rte_eal_config_create();</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Process type(%d) not supported\n&quot;</span>,</span><br><span class="line">			  rte_config.process_type);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eal-hugepage-info-init"><a href="#eal-hugepage-info-init" class="headerlink" title="eal_hugepage_info_init"></a>eal_hugepage_info_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1ULL &lt;&lt; 21 = 2M</span></span><br><span class="line"><span class="comment"> * ULL = unsigned long long</span></span><br><span class="line"><span class="comment"> * 2^10bit = 1KB</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> huge_page_size = RTE_PGSIZE_2M</span><br><span class="line"><span class="type">int</span> eal_hugepage_info_init(<span class="type">void</span>)&#123;</span><br><span class="line">	<span class="type">uint32_t</span> nr_page;</span><br><span class="line">	<span class="type">int</span> left_mem = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hugepage_info</span> *<span class="title">hpi</span>;</span>	</span><br><span class="line">	hpi = &amp;internal_config.hugepage_info[<span class="number">0</span>];</span><br><span class="line">	<span class="comment">// 获取剩余内存</span></span><br><span class="line">	left_mem = uk_alloc_availmem(uk_alloc_get_default());</span><br><span class="line">	<span class="keyword">if</span> (left_mem &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		uk_pr_err(<span class="string">&quot;Failed to fetch the available memory\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> left_mem;</span><br><span class="line">	&#125;</span><br><span class="line">	hpi-&gt;hugepage_sz =  huge_page_size;</span><br><span class="line">	<span class="comment">// 计算页数</span></span><br><span class="line">	hpi-&gt;num_pages[<span class="number">0</span>] =  left_mem / huge_page_size;</span><br><span class="line">	internal_config.num_hugepage_sizes = <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s: left memory: %llu huge pages of size: %d and count: %d\n&quot;</span>,</span><br><span class="line">		__func__, left_mem, huge_page_size, hpi-&gt;num_pages[<span class="number">0</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-eal-memzone-init"><a href="#rte-eal-memzone-init" class="headerlink" title="rte_eal_memzone_init"></a>rte_eal_memzone_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">rte_eal_memzone_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mem_config</span> *<span class="title">mcfg</span>;</span></span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* get pointer to global configuration */</span></span><br><span class="line">	mcfg = rte_eal_get_configuration()-&gt;mem_config;</span><br><span class="line">	rte_rwlock_write_lock(&amp;mcfg-&gt;mlock);</span><br><span class="line">	<span class="comment">// 主进程中初始化 fbarray，子进程中连接主进程的 fbarray</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_process_type() == RTE_PROC_PRIMARY &amp;&amp;</span><br><span class="line">			rte_fbarray_init(&amp;mcfg-&gt;memzones, <span class="string">&quot;memzone&quot;</span>,</span><br><span class="line">			RTE_MAX_MEMZONE, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> rte_memzone))) &#123;</span><br><span class="line">		RTE_LOG(ERR, EAL, <span class="string">&quot;Cannot allocate memzone list\n&quot;</span>);</span><br><span class="line">		ret = <span class="number">-1</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rte_eal_process_type() == RTE_PROC_SECONDARY &amp;&amp;</span><br><span class="line">			rte_fbarray_attach(&amp;mcfg-&gt;memzones)) &#123;</span><br><span class="line">		RTE_LOG(ERR, EAL, <span class="string">&quot;Cannot attach to memzone list\n&quot;</span>);</span><br><span class="line">		ret = <span class="number">-1</span>;</span><br><span class="line">	</span><br><span class="line">	rte_rwlock_write_unlock(&amp;mcfg-&gt;mlock);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-eal-memory-init"><a href="#rte-eal-memory-init" class="headerlink" title="rte_eal_memory_init"></a>rte_eal_memory_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">rte_eal_memory_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mem_config</span> *<span class="title">mcfg</span> =</span> rte_eal_get_configuration()-&gt;mem_config;</span><br><span class="line">	<span class="type">int</span> retval;</span><br><span class="line">	RTE_LOG(DEBUG, EAL, <span class="string">&quot;Setting up physically contiguous memory...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!mcfg)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* lock mem hotplug here, to prevent races while we init */</span></span><br><span class="line">	rte_mcfg_mem_read_lock();</span><br><span class="line">	<span class="comment">// 初始化内存段</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_memseg_init() &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (eal_memalloc_init() &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	<span class="comment">// 若为主进程则初始化 hugepage，若为子进程则连接主进程的 hugepage</span></span><br><span class="line">	retval = rte_eal_process_type() == RTE_PROC_PRIMARY ?</span><br><span class="line">			rte_eal_hugepage_init() :</span><br><span class="line">			rte_eal_hugepage_attach();</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (internal_config.no_shconf == <span class="number">0</span> &amp;&amp; rte_eal_memdevice_init() &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">	rte_mcfg_mem_read_unlock();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-eal-malloc-heap-init"><a href="#rte-eal-malloc-heap-init" class="headerlink" title="rte_eal_malloc_heap_init"></a>rte_eal_malloc_heap_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">rte_eal_malloc_heap_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mem_config</span> *<span class="title">mcfg</span> =</span> rte_eal_get_configuration()-&gt;mem_config;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">internal_config</span> *<span class="title">internal_conf</span> =</span></span><br><span class="line">		eal_get_internal_configuration();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (internal_conf-&gt;match_allocations)</span><br><span class="line">		RTE_LOG(DEBUG, EAL, <span class="string">&quot;Hugepages will be freed exactly as allocated.\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_process_type() == RTE_PROC_PRIMARY) &#123;</span><br><span class="line">		<span class="comment">/* assign min socket ID to external heaps */</span></span><br><span class="line">		mcfg-&gt;next_socket_id = EXTERNAL_HEAP_MIN_SOCKET_ID;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* assign names to default DPDK heaps */</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rte_socket_count(); i++) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">malloc_heap</span> *<span class="title">heap</span> =</span> &amp;mcfg-&gt;malloc_heaps[i];</span><br><span class="line">			<span class="type">char</span> heap_name[RTE_HEAP_NAME_MAX_LEN];</span><br><span class="line">			<span class="type">int</span> socket_id = rte_socket_id_by_idx(i);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">snprintf</span>(heap_name, <span class="keyword">sizeof</span>(heap_name),</span><br><span class="line">					<span class="string">&quot;socket_%i&quot;</span>, socket_id);</span><br><span class="line">			strlcpy(heap-&gt;name, heap_name, RTE_HEAP_NAME_MAX_LEN);</span><br><span class="line">			heap-&gt;socket_id = socket_id;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (register_mp_requests()) &#123;</span><br><span class="line">		RTE_LOG(ERR, EAL, <span class="string">&quot;Couldn&#x27;t register malloc multiprocess actions\n&quot;</span>);</span><br><span class="line">		rte_mcfg_mem_read_unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* unlock mem hotplug here. it&#x27;s safe for primary as no requests can</span></span><br><span class="line"><span class="comment">	 * even come before primary itself is fully initialized, and secondaries</span></span><br><span class="line"><span class="comment">	 * do not need to initialize the heap.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	rte_mcfg_mem_read_unlock();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* secondary process does not need to initialize anything */</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_process_type() != RTE_PROC_PRIMARY)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* add all IOVA-contiguous areas to the heap */</span></span><br><span class="line">	<span class="keyword">return</span> rte_memseg_contig_walk(malloc_add_seg, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="rte-eal-tailqs-init"><a href="#rte-eal-tailqs-init" class="headerlink" title="rte_eal_tailqs_init"></a>rte_eal_tailqs_init</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">rte_eal_tailqs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_tailq_elem</span> *<span class="title">t</span>;</span></span><br><span class="line"></span><br><span class="line">	rte_tailqs_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	TAILQ_FOREACH(t, &amp;rte_tailq_elem_head, next) &#123;</span><br><span class="line">		<span class="comment">/* second part of register job for &quot;early&quot; tailqs, see</span></span><br><span class="line"><span class="comment">		 * rte_eal_tailq_register and EAL_REGISTER_TAILQ */</span></span><br><span class="line">		rte_eal_tailq_update(t);</span><br><span class="line">		<span class="keyword">if</span> (t-&gt;head == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			RTE_LOG(ERR, EAL,</span><br><span class="line">				<span class="string">&quot;Cannot initialize tailq: %s\n&quot;</span>, t-&gt;name);</span><br><span class="line">			<span class="comment">/* TAILQ_REMOVE not needed, error is already fatal */</span></span><br><span class="line">			<span class="keyword">goto</span> fail;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line">	rte_dump_tailq(<span class="built_in">stderr</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="eal-thread-init-master"><a href="#eal-thread-init-master" class="headerlink" title="eal_thread_init_master"></a>eal_thread_init_master</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">eal_thread_init_master</span><span class="params">(<span class="type">unsigned</span> lcore_id)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* set the lcore ID in per-lcore memory area */</span></span><br><span class="line">	RTE_PER_LCORE(_lcore_id) = lcore_id;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set CPU affinity */</span></span><br><span class="line">	<span class="keyword">if</span> (eal_thread_set_affinity() &lt; <span class="number">0</span>)</span><br><span class="line">		UK_CRASH(<span class="string">&quot;Failed to set thread affinity\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="uk-dpdk-libs-libuk-pmd-uk-pmd-c-eal-uknetdev-init"><a href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-eal-uknetdev-init" class="headerlink" title="uk-dpdk/libs/libuk_pmd/uk_pmd.c/eal_uknetdev_init"></a><code>uk-dpdk/libs/libuk_pmd/uk_pmd.c/eal_uknetdev_init</code></h2><p>通过 for 循环遍历所有的 uk_netdev 并将其转化为对应的 eth_dev</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">eal_uknetdev_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> cnt = <span class="number">0</span>, i, rc;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uk_netdev</span> *<span class="title">dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTE_ETHDEV_NAMESIZE  5</span></span><br><span class="line">	<span class="type">char</span> name[RTE_ETHDEV_NAMESIZE];</span><br><span class="line"></span><br><span class="line">	cnt = uk_netdev_count();</span><br><span class="line">	<span class="comment">// 将每一个 uk_netdev 注册成 eth_dev</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cnt; i++) &#123;</span><br><span class="line">		dev = uk_netdev_get(i);</span><br><span class="line">		<span class="keyword">if</span> (!dev)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		uk_pr_info(DRIVER_NAME<span class="string">&quot;: Registered netdev id %d @ %p\n&quot;</span>, i, dev);</span><br><span class="line">		<span class="built_in">snprintf</span>(name, <span class="keyword">sizeof</span>(name), <span class="string">&quot;uk%02d&quot;</span>, i);</span><br><span class="line">		rc = uk_ethdev_create(dev, name, eal_cpu_socket_id(), <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (rc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			uk_pr_err(<span class="string">&quot;Failed to create the ethdev\n&quot;</span>);</span><br><span class="line">			<span class="keyword">goto</span> err_exit;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_exit:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-create"><a href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-create" class="headerlink" title="uk-dpdk/libs/libuk_pmd/uk_pmd.c/uk_ethdev_create"></a><code>uk-dpdk/libs/libuk_pmd/uk_pmd.c/uk_ethdev_create</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">uk_ethdev_create</span><span class="params">(<span class="keyword">struct</span> uk_netdev *dev, <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">			    <span class="type">uint8_t</span> socket_id,</span></span><br><span class="line"><span class="params">			    <span class="type">uint8_t</span> isr_support)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CONFIG_PCI_BUS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_pci_device</span> *<span class="title">pci_dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_pci_driver</span> *<span class="title">pci_drv</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_pci_id</span> *<span class="title">id_table</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_dev</span> *<span class="title">eth_dev</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uk_ethdev_private</span> *<span class="title">dev_private</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">char</span> name_buf[RTE_RING_NAMESIZE];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BUS</span></span><br><span class="line">	<span class="comment">/* now do all data allocation - for eth_dev structure, dummy pci driver</span></span><br><span class="line"><span class="comment">	 * and internal (dev_private) data</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	pci_dev = rte_zmalloc_socket(name, <span class="keyword">sizeof</span>(*pci_dev), <span class="number">0</span>, socket_id);</span><br><span class="line">	<span class="keyword">if</span> (pci_dev == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	pci_drv = rte_zmalloc_socket(name, <span class="keyword">sizeof</span>(*pci_drv), <span class="number">0</span>, socket_id);</span><br><span class="line">	<span class="keyword">if</span> (pci_drv == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	id_table = rte_zmalloc_socket(name, <span class="keyword">sizeof</span>(*id_table), <span class="number">0</span>, socket_id);</span><br><span class="line">	<span class="keyword">if</span> (id_table == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line">	id_table-&gt;device_id = <span class="number">0xBEEF</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_PCI_BUS */</span></span></span><br><span class="line">	<span class="comment">// 在特定的 heap 分配内存</span></span><br><span class="line">	dev_private = rte_zmalloc_socket(name, <span class="keyword">sizeof</span>(*dev_private), <span class="number">0</span>, socket_id);</span><br><span class="line">	<span class="keyword">if</span> (dev_private == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	dev_private-&gt;netdev = dev; </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_UK_NETDEV_RING</span></span><br><span class="line">	<span class="comment">// 创建环队列</span></span><br><span class="line">	<span class="built_in">snprintf</span>(name_buf, <span class="keyword">sizeof</span>(name_buf), <span class="string">&quot;%s_rxQ&quot;</span>, name);</span><br><span class="line">	dev_private-&gt;rx_queue = rte_ring_create(name_buf, MAX_PKT_BURST, socket_id,</span><br><span class="line">			<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (dev_private-&gt;rx_queue == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">snprintf</span>(name_buf, <span class="keyword">sizeof</span>(name_buf), <span class="string">&quot;%s_txQ&quot;</span>, name);</span><br><span class="line">	dev_private-&gt;tx_queue = rte_ring_create(name_buf, MAX_PKT_BURST, socket_id,</span><br><span class="line">			<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (dev_private-&gt;tx_queue == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_UK_NETDEV_RING */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* reserve an ethdev entry */</span> </span><br><span class="line">	eth_dev = rte_eth_dev_allocate(name);</span><br><span class="line">	<span class="keyword">if</span> (eth_dev == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BUS</span></span><br><span class="line">	pci_dev-&gt;device.numa_node = socket_id;</span><br><span class="line">	pci_dev-&gt;device.name = eth_dev-&gt;data-&gt;name;</span><br><span class="line">	pci_drv-&gt;driver.name = uk_ethdev_driver_name;</span><br><span class="line">	pci_drv-&gt;id_table = id_table;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (isr_support)</span><br><span class="line">		pci_drv-&gt;drv_flags |= RTE_PCI_DRV_INTR_LSC;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		pci_drv-&gt;drv_flags &amp;= ~RTE_PCI_DRV_INTR_LSC;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_PCI_BUS */</span></span></span><br><span class="line">	<span class="comment">// 配置 eth_dev</span></span><br><span class="line">	eth_dev-&gt;device = &amp;dev_private-&gt;dev;</span><br><span class="line">	eth_dev-&gt;device-&gt;driver = &amp;uk_netdev_driver;</span><br><span class="line"></span><br><span class="line">	eth_dev-&gt;data-&gt;nb_rx_queues = (<span class="type">uint16_t</span>)<span class="number">1</span>;</span><br><span class="line">	eth_dev-&gt;data-&gt;nb_tx_queues = (<span class="type">uint16_t</span>)<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	eth_dev-&gt;data-&gt;dev_link.link_status = ETH_LINK_DOWN;</span><br><span class="line">	eth_dev-&gt;data-&gt;dev_link.link_speed = ETH_SPEED_NUM_10G;</span><br><span class="line">	eth_dev-&gt;data-&gt;dev_link.link_duplex = ETH_LINK_FULL_DUPLEX;</span><br><span class="line"></span><br><span class="line">	eth_dev-&gt;data-&gt;mac_addrs = rte_zmalloc(name, RTE_ETHER_ADDR_LEN, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (eth_dev-&gt;data-&gt;mac_addrs == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEFAULT_HWADDR</span></span><br><span class="line">	<span class="built_in">memcpy</span>(eth_dev-&gt;data-&gt;mac_addrs, mac_addr,</span><br><span class="line">			<span class="keyword">sizeof</span>(*eth_dev-&gt;data-&gt;mac_addrs));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEFAULT_HWADDR */</span></span></span><br><span class="line"></span><br><span class="line">	eth_dev-&gt;data-&gt;dev_started = <span class="number">0</span>;</span><br><span class="line">	eth_dev-&gt;data-&gt;promiscuous = <span class="number">0</span>;</span><br><span class="line">	eth_dev-&gt;data-&gt;scattered_rx = <span class="number">0</span>;</span><br><span class="line">	eth_dev-&gt;data-&gt;all_multicast = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	eth_dev-&gt;data-&gt;dev_private = dev_private;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy default device operation functions */</span></span><br><span class="line">	dev_private-&gt;dev_ops = uk_ethdev_default_dev_ops;</span><br><span class="line">	eth_dev-&gt;dev_ops = &amp;dev_private-&gt;dev_ops;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BUS</span></span><br><span class="line">	pci_dev-&gt;device.driver = &amp;pci_drv-&gt;driver;</span><br><span class="line">	eth_dev-&gt;device = &amp;pci_dev-&gt;device;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_PCI_BUS */</span></span></span><br><span class="line">	<span class="comment">// 注册收发函数</span></span><br><span class="line">	eth_dev-&gt;rx_pkt_burst = uk_ethdev_rx_burst;</span><br><span class="line">	eth_dev-&gt;tx_pkt_burst = uk_ethdev_tx_burst;</span><br><span class="line"></span><br><span class="line">	rte_eth_dev_probing_finish(eth_dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> eth_dev-&gt;data-&gt;port_id;</span><br><span class="line"></span><br><span class="line">err:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PCI_BUS */</span></span><br><span class="line">	rte_free(pci_dev);</span><br><span class="line">	rte_free(pci_drv);</span><br><span class="line">	rte_free(id_table);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_PCI_BUS */</span></span></span><br><span class="line">	rte_free(dev_private);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="dpdk-lib-ethdev-rte-ethdev-c-rte-eth-dev-probing-finish"><a href="#dpdk-lib-ethdev-rte-ethdev-c-rte-eth-dev-probing-finish" class="headerlink" title="dpdk/lib/ethdev/rte_ethdev.c/rte_eth_dev_probing_finish"></a><code>dpdk/lib/ethdev/rte_ethdev.c/rte_eth_dev_probing_finish</code></h2><p>fast path 结构体在 rte_ethdev.c 中声明并完成赋值。以 rte_eth_fp_ops 作为首地址，设备的端口作为偏移量进行设置后即可以数组的形式快速获取到相应的操作函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* public fast-path API */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_fp_ops</span> <span class="title">rte_eth_fp_ops</span>[<span class="title">RTE_MAX_ETHPORTS</span>];</span></span><br><span class="line"><span class="comment">// 该函数的调用者是 init 流程中的 uk_ethdev_create</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">rte_eth_dev_probing_finish</span><span class="params">(<span class="keyword">struct</span> rte_eth_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (dev == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * for secondary process, at that point we expect device</span></span><br><span class="line"><span class="comment">	 * to be already &#x27;usable&#x27;, so shared data and all function pointers</span></span><br><span class="line"><span class="comment">	 * for fast-path devops have to be setup properly inside rte_eth_dev.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (rte_eal_process_type() == RTE_PROC_SECONDARY)</span><br><span class="line">		eth_dev_fp_ops_setup(rte_eth_fp_ops + dev-&gt;data-&gt;port_id, dev);</span><br><span class="line"></span><br><span class="line">	rte_eth_dev_callback_process(dev, RTE_ETH_EVENT_NEW, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	dev-&gt;state = RTE_ETH_DEV_ATTACHED;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">rte_eth_dev_callback_process</span><span class="params">(<span class="keyword">struct</span> rte_eth_dev *dev,</span></span><br><span class="line"><span class="params">	<span class="keyword">enum</span> rte_eth_event_type event, <span class="type">void</span> *ret_param)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_dev_callback</span> *<span class="title">cb_lst</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_dev_callback</span> <span class="title">dev_cb</span>;</span></span><br><span class="line">	<span class="type">int</span> rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	rte_spinlock_lock(&amp;eth_dev_cb_lock);</span><br><span class="line">	TAILQ_FOREACH(cb_lst, &amp;(dev-&gt;link_intr_cbs), next) &#123;</span><br><span class="line">		<span class="keyword">if</span> (cb_lst-&gt;cb_fn == <span class="literal">NULL</span> || cb_lst-&gt;event != event)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		dev_cb = *cb_lst;</span><br><span class="line">		cb_lst-&gt;active = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (ret_param != <span class="literal">NULL</span>)</span><br><span class="line">			dev_cb.ret_param = ret_param;</span><br><span class="line"></span><br><span class="line">		rte_spinlock_unlock(&amp;eth_dev_cb_lock);</span><br><span class="line">		rc = dev_cb.cb_fn(dev-&gt;data-&gt;port_id, dev_cb.event,</span><br><span class="line">				dev_cb.cb_arg, dev_cb.ret_param);</span><br><span class="line">		rte_spinlock_lock(&amp;eth_dev_cb_lock);</span><br><span class="line">		cb_lst-&gt;active = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	rte_spinlock_unlock(&amp;eth_dev_cb_lock);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将 device 中注册好的的函数传递给 fp_ops</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">eth_dev_fp_ops_setup</span><span class="params">(<span class="keyword">struct</span> rte_eth_fp_ops *fpo,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="keyword">struct</span> rte_eth_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	fpo-&gt;rx_pkt_burst = dev-&gt;rx_pkt_burst;</span><br><span class="line">	fpo-&gt;tx_pkt_burst = dev-&gt;tx_pkt_burst;</span><br><span class="line">	fpo-&gt;tx_pkt_prepare = dev-&gt;tx_pkt_prepare;</span><br><span class="line">	fpo-&gt;rx_queue_count = dev-&gt;rx_queue_count;</span><br><span class="line">	fpo-&gt;rx_descriptor_status = dev-&gt;rx_descriptor_status;</span><br><span class="line">	fpo-&gt;tx_descriptor_status = dev-&gt;tx_descriptor_status;</span><br><span class="line"></span><br><span class="line">	fpo-&gt;rxq.data = dev-&gt;data-&gt;rx_queues;</span><br><span class="line">	fpo-&gt;rxq.clbk = (<span class="type">void</span> **)(<span class="type">uintptr_t</span>)dev-&gt;post_rx_burst_cbs;</span><br><span class="line"></span><br><span class="line">	fpo-&gt;txq.data = dev-&gt;data-&gt;tx_queues;</span><br><span class="line">	fpo-&gt;txq.clbk = (<span class="type">void</span> **)(<span class="type">uintptr_t</span>)dev-&gt;pre_tx_burst_cbs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="接收数据包"><a href="#接收数据包" class="headerlink" title="接收数据包"></a>接收数据包</h1><h2 id="dpdk-lib-ethdev-rte-ethdev-h-rte-eth-rx-burst"><a href="#dpdk-lib-ethdev-rte-ethdev-h-rte-eth-rx-burst" class="headerlink" title="dpdk/lib/ethdev/rte_ethdev.h/rte_eth_rx_burst"></a><code>dpdk/lib/ethdev/rte_ethdev.h/rte_eth_rx_burst</code></h2><p>DPDK 中提供给上层应用的接收函数为 <code>rte_eth_rx_burst</code>，该函数通过端口 ID 与队列 ID 将 nb_pkts 数量的数据包取出至 rx_pkts 中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint16_t</span></span><br><span class="line"><span class="title function_">rte_eth_rx_burst</span><span class="params">(<span class="type">uint16_t</span> port_id, <span class="type">uint16_t</span> queue_id,</span></span><br><span class="line"><span class="params">		 <span class="keyword">struct</span> rte_mbuf **rx_pkts, <span class="type">const</span> <span class="type">uint16_t</span> nb_pkts)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint16_t</span> nb_rx;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_fp_ops</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="type">void</span> *qd;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTE_ETHDEV_DEBUG_RX</span></span><br><span class="line">	<span class="keyword">if</span> (port_id &gt;= RTE_MAX_ETHPORTS ||</span><br><span class="line">			queue_id &gt;= RTE_MAX_QUEUES_PER_PORT) &#123;</span><br><span class="line">		RTE_ETHDEV_LOG(ERR,</span><br><span class="line">			<span class="string">&quot;Invalid port_id=%u or queue_id=%u\n&quot;</span>,</span><br><span class="line">			port_id, queue_id);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* fetch pointer to queue data */</span></span><br><span class="line">	<span class="comment">// 通过端口号和队列号取出相应结构体</span></span><br><span class="line">	p = &amp;rte_eth_fp_ops[port_id];</span><br><span class="line">	qd = p-&gt;rxq.data[queue_id];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTE_ETHDEV_DEBUG_RX</span></span><br><span class="line">	RTE_ETH_VALID_PORTID_OR_ERR_RET(port_id, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (qd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		RTE_ETHDEV_LOG(ERR, <span class="string">&quot;Invalid Rx queue_id=%u for port_id=%u\n&quot;</span>,</span><br><span class="line">			queue_id, port_id);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// 调用 fast path 中注册好的 rx_pkt_burst</span></span><br><span class="line">	nb_rx = p-&gt;rx_pkt_burst(qd, rx_pkts, nb_pkts);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTE_ETHDEV_RXTX_CALLBACKS</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">void</span> *cb;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* __ATOMIC_RELEASE memory order was used when the</span></span><br><span class="line"><span class="comment">		 * call back was inserted into the list.</span></span><br><span class="line"><span class="comment">		 * Since there is a clear dependency between loading</span></span><br><span class="line"><span class="comment">		 * cb and cb-&gt;fn/cb-&gt;next, __ATOMIC_ACQUIRE memory order is</span></span><br><span class="line"><span class="comment">		 * not required.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		cb = __atomic_load_n((<span class="type">void</span> **)&amp;p-&gt;rxq.clbk[queue_id],</span><br><span class="line">				__ATOMIC_RELAXED);</span><br><span class="line">		<span class="keyword">if</span> (unlikely(cb != <span class="literal">NULL</span>))</span><br><span class="line">			nb_rx = rte_eth_call_rx_callbacks(port_id, queue_id,</span><br><span class="line">					rx_pkts, nb_rx, nb_pkts, cb);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">// 创建一个追踪点</span></span><br><span class="line">	rte_ethdev_trace_rx_burst(port_id, queue_id, (<span class="type">void</span> **)rx_pkts, nb_rx);</span><br><span class="line">	<span class="keyword">return</span> nb_rx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-rx-burst"><a href="#uk-dpdk-libs-libuk-pmd-uk-pmd-c-uk-ethdev-rx-burst" class="headerlink" title="uk-dpdk/libs/libuk_pmd/uk_pmd.c/uk_ethdev_rx_burst"></a><code>uk-dpdk/libs/libuk_pmd/uk_pmd.c/uk_ethdev_rx_burst</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> <span class="title function_">uk_ethdev_rx_burst</span><span class="params">(<span class="type">void</span> *<span class="built_in">queue</span>,</span></span><br><span class="line"><span class="params">				   <span class="keyword">struct</span> rte_mbuf **bufs,</span></span><br><span class="line"><span class="params">				   <span class="type">uint16_t</span> nb_pkts)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_eth_dev</span> *<span class="title">vrtl_eth_dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uk_ethdev_private</span> *<span class="title">dev_private</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uk_ethdev_queue</span> *<span class="title">rxq</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">uk_netbuf</span> *<span class="title">nb</span>[<span class="title">MAX_PKT_BURST</span>];</span></span><br><span class="line">	<span class="type">int</span> rx_burst_size = (nb_pkts &gt; MAX_PKT_BURST)? MAX_PKT_BURST:nb_pkts;</span><br><span class="line">	<span class="type">int</span> rx_count = <span class="number">0</span>, i, rc, idx;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rte_mbuf</span> *<span class="title">mbuf</span>;</span></span><br><span class="line"></span><br><span class="line">	UK_ASSERT(<span class="built_in">queue</span> &amp;&amp; bufs);</span><br><span class="line">	<span class="comment">// 获取队列以及 netdev</span></span><br><span class="line">	rxq = (<span class="keyword">struct</span> uk_ethdev_private *) <span class="built_in">queue</span>;</span><br><span class="line">	vrtl_eth_dev = &amp;rte_eth_devices[rxq-&gt;port_id];</span><br><span class="line">	dev_private = vrtl_eth_dev-&gt;data-&gt;dev_private;</span><br><span class="line">	UK_ASSERT(dev_private);</span><br><span class="line">	<span class="comment">// 限制最大收包数</span></span><br><span class="line">	nb_pkts = (nb_pkts &gt; MAX_PKT_BURST)? MAX_PKT_BURST:nb_pkts;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(!vrtl_eth_dev-&gt;data-&gt;dev_link.link_status)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">while</span> (rx_count &lt; nb_pkts) &#123;</span><br><span class="line">			rx_burst_size = nb_pkts - rx_count;</span><br><span class="line">			<span class="comment">// 调用 netdev 中的 rx 函数进行收包</span></span><br><span class="line">			rc = uk_netdev_rx_burst(dev_private-&gt;netdev,</span><br><span class="line">					rxq-&gt;queue_id, &amp;nb[rx_count],</span><br><span class="line">					&amp;rx_burst_size);</span><br><span class="line">			idx = rx_count;</span><br><span class="line">			<span class="comment">// 使用接收到的包填充 mbuf</span></span><br><span class="line">			<span class="keyword">for</span> (i = idx; i &lt; idx + rx_burst_size; i++) &#123;</span><br><span class="line">				rx_count++;</span><br><span class="line">				UK_ASSERT(nb[i]);</span><br><span class="line">				mbuf = nb[i]-&gt;priv;</span><br><span class="line">				<span class="comment">//printf(&quot;%s: mbuf %p\n&quot;, __func__, mbuf);</span></span><br><span class="line">				<span class="comment">/**</span></span><br><span class="line"><span class="comment">				 * <span class="doctag">TODO:</span> Fill in the mbuf for packet processing</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				mbuf-&gt;port = rxq-&gt;port_id;</span><br><span class="line">				<span class="comment">//mbuf-&gt;data_off = nb[i]-&gt;data - nb[i]-&gt;buf;</span></span><br><span class="line">				mbuf-&gt;ol_flags = <span class="number">0</span>;</span><br><span class="line">				mbuf-&gt;vlan_tci = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">				mbuf-&gt;pkt_len = nb[i]-&gt;len;</span><br><span class="line">				mbuf-&gt;data_len = nb[i]-&gt;len;</span><br><span class="line">				bufs[i] = mbuf;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!uk_netdev_status_more(rc))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* increments ipackets count */</span></span><br><span class="line">	<span class="comment">// 增加成功接收包的数量</span></span><br><span class="line">	dev_private-&gt;eth_stats.ipackets += rx_count;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* increments ibytes count */</span></span><br><span class="line">	<span class="comment">// 增加成功接收字节数</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; rx_count; i++)</span><br><span class="line">		dev_private-&gt;eth_stats.ibytes += rte_pktmbuf_pkt_len(bufs[i]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rx_count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://example.com/2022/11/12/uk_dpdk%EF%BC%88%E9%A9%B1%E5%8A%A8%E9%83%A8%E5%88%86%EF%BC%89/" title="uk_dpdk（驱动部分）" target="_blank" rel="external">http://example.com/2022/11/12/uk_dpdk（驱动部分）/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/TenonOS" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/TenonOS" target="_blank"><span class="text-dark">TenonOS</span><small class="ml-1x">unikraft-learning</small></a></h3>
        <div>个人简介。</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2022/11/12/Unikraft%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" title="Unikraft启动过程"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2022/11/12/ukblkdev/" title="ukblkdev源码阅读"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/TenonOS" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Twitter" data-toggle=tooltip data-placement=top><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/null" target="_blank" title="Behance" data-toggle=tooltip data-placement=top><i class="icon icon-behance"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   




   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: false,
    appId: '',
    appKey: '',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>